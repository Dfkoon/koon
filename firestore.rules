rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Admin Helper Function
    function isAdmin() {
      return request.auth != null && 
             (request.auth.token.email == 'hussienaldayyat@gmail.com' || 
              request.auth.token.email == 'admin@koon.com');
    }

    // General Helper Functions
    function isAuth() {
      return request.auth != null;
    }

    // QnA / Suggestions Collection
    match /qna/{docId} {
      allow read: if resource.data.isPublic == true || isAdmin();
      allow create: if true; // Allow anyone to post
      allow update, delete: if isAdmin();
    }
    
    // Legacy Suggestions Support
    match /suggestions/{docId} {
      allow read: if resource.data.isPublic == true || isAdmin();
      allow create: if true;
      allow update, delete: if isAdmin();
    }

    // Testimonials
    match /testimonials/{docId} {
      allow read: if resource.data.status == 'approved' || isAdmin();
      allow create: if true;
      allow update, delete: if isAdmin();
    }

    // Material Exchange
    match /materialDonations/{docId} {
      allow read: if true;
      allow create: if true;
      allow update, delete: if isAdmin();
    }

    // Question Reports (New)
    match /question_reports/{docId} {
      allow read: if isAdmin();
      allow create: if true; // Allow students to report
      allow update, delete: if isAdmin();
    }

    // Users / Admins (Future Proofing)
    match /users/{userId} {
      allow read, write: if request.auth.uid == userId || isAdmin();
    }
  }
}
