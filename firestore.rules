rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Admin Helper Function
    function isAdmin() {
      return request.auth != null && 
             request.auth.token.email in ['admin@koon.bau.jo', 'hussienaldayyat@gmail.com'];
    }
    
    // Validation Helpers
    function isValidMessage(data) {
      let content = data.keys().hasAny(['message']) ? data.message :
                    data.keys().hasAny(['text']) ? data.text :
                    data.keys().hasAny(['content']) ? data.content :
                    data.keys().hasAny(['quote']) ? data.quote : '';
      
      return content is string && content.size() >= 5 && content.size() <= 2000;
    }
    
    function isValidEmail(email) {
      return email is string && email.matches('.*@.*\\..*');
    }

    // QnA / Suggestions (Existing)
    match /qna/{doc} {
      allow read: if resource.data.isPublic == true || isAdmin();
      allow create: if isValidMessage(request.resource.data) && (request.resource.data.type is string);
      allow update, delete: if isAdmin();
    }
    
    match /suggestions/{doc} {
      allow read: if resource.data.isPublic == true || isAdmin();
      allow create: if isValidMessage(request.resource.data) && (request.resource.data.type is string);
      allow update, delete: if isAdmin();
    }

    // Question Reports (Existing)
    match /question_reports/{report} {
      allow read, update, delete: if isAdmin();
      allow create: if isValidMessage(request.resource.data);
    }

    // Page Views (Existing)
    match /page_views/{view} {
      allow read: if isAdmin();
      allow create: if true;
      allow update, delete: if false;
    }

    // Material Donations (Existing)
    match /materialDonations/{doc} {
      allow read: if isAdmin();
      allow create: if request.resource.data.itemName is string && request.resource.data.itemName.size() > 0;
      allow update, delete: if isAdmin();
    }

    // Subscribers (Existing)
    match /subscribers/{doc} {
      allow read, delete: if isAdmin();
      allow create: if isValidEmail(request.resource.data.email);
    }

    // Testimonials (Existing)
    match /testimonials/{doc} {
      allow read: if resource.data.approved == true || isAdmin();
      allow create: if isValidMessage(request.resource.data);
      allow update, delete: if isAdmin();
    }

    // Requests (Existing)
    match /requests/{doc} {
      allow read, write: if isAdmin();
    }

    // ========== NEW COLLECTIONS ==========

    // Student Contributions (Quiz Files/Links) - NEW
    match /quizContributions/{doc} {
      allow read: if isAdmin();
      allow create: if true; // Allow students to submit
      allow update, delete: if isAdmin();
    }

    // Nashmi Chat Logs - NEW
    match /nashmi_chat/{doc} {
      allow read: if isAdmin();
      allow create: if true; // Allow anyone (students) to save chat logs
      allow update, delete: if isAdmin();
    }

    // Nashmi Knowledge Base - NEW
    match /nashmi_knowledge/{doc} {
      allow read: if true; // Allow bot to read verified knowledge
      allow create, update, delete: if isAdmin();
    }

    // Site Broadcasts - NEW
    match /broadcasts/{doc} {
      allow read: if true; // Publicly readable for students
      allow create, update, delete: if isAdmin();
    }

    // System Settings (Phases, etc.) - NEW
    match /settings/{doc} {
      allow read: if true; // Publicly readable
      allow create, update, delete: if isAdmin();
    }

    // Users / Admins - NEW
    match /users/{userId} {
      allow read, write: if request.auth.uid == userId || isAdmin();
    }

    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
